<html>
    <head>
        <title>OneMap2 XYZ (Default)</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">
        <!-- onemap's leaflet is 0.7.7 -->
        <!-- link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" / -->
        
        <!-- script src="https://cdn.onemap.sg/leaflet/onemap-leaflet.js"></script -->

    </head>
    <body>
    <h1>Singapore Map</h1>
    <div id='mapdiv' style='height:800px;'></div>
    </body>
    
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/togeojson@0.16.0"></script>
    <script src="https://unpkg.com/leaflet-filelayer@1.2.0"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script>
    var activeLayer;
    
    var center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
    var map = L.map('mapdiv').setView([center.x, center.y], 12);

    var basemap = L.tileLayer('https://maps-{s}.onemap.sg/v3/Default/{z}/{x}/{y}.png', {
        detectRetina: true,
        maxZoom: 18,
        minZoom: 11
    });

    map.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);

    basemap.addTo(map);

    var baseMaps = {
      "Base Layer": basemap
    };  
    var overlayMaps = {
    };
    
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } 
    }

    function showPosition(position) {						
        marker = new L.Marker([position.coords.latitude, position.coords.longitude], {bounceOnAdd: false}).addTo(map);						 
        var popup = L.popup()
        .setLatLng([position.coords.latitude, position.coords.longitude]) 
        .setContent('You are here!')
        .openOn(map);					
    }
    
    var defaultStyle = {
        color: 'red',
        opacity: 0.5,
        fillOpacity: 0.5,
        weight: 6,
        clickable: false
    };
 
    var highlightStyle = {
        color: 'green', 
        weight: 6,
        opacity: 0.6,
        fillOpacity: 0.65,
        fillColor: 'green'
    }; 
    
    function zoomToFeature(event) {
        console.log("zoom");
    }
    
    function highlightFeature(event, feature, layer) {
        console.log("highlight", event, feature, layer);
        
        // Change the style to the highlighted version
        layer.setStyle(highlightStyle);
        
        layer.openPopup();
    }
    
    function resetHighlight(event) {
        //console.log("reset");
        
        // Start by reverting the style back
        event.target.setStyle(defaultStyle); 
        event.target.closePopup();
        // And then destroying the popup
        $("#popup").remove();       
    }
    // http://palewi.re/posts/2012/03/26/leaflet-recipe-hover-events-features-and-polygons/
    var onEachFeature = function(feature, layer) {
        console.log("eachfeature", feature, layer);
        
        // Load the default style. 
        layer.setStyle(defaultStyle);
        // Create a self-invoking function that passes in the layer
        // and the properties associated with this particular record.

        if (feature.properties && feature.properties.popupContent) {

        }  
        
        // Create a mouseover event
        //layer.on({
        //    mouseover: function(e) {    
        //        highlightFeature(e, feature, layer); 
        //    }
        //});

        //layer.bindPopup('<h1>'+feature.properties+'</h1><p>name: '+feature.properties+'</p>');console.log("properties", feature.properties, feature.geometry);         

        
    };    
    
    var control = L.Control.fileLayerLoad({
        // Allows you to use a customized version of L.geoJson.
        // For example if you are using the Proj4Leaflet leaflet plugin,
        // you can pass L.Proj.geoJson and load the files into the
        // L.Proj.GeoJson instead of the L.geoJson.
        layer: L.geoJson,
        // See http://leafletjs.com/reference.html#geojson-options
        
        layerOptions: {    
            style: defaultStyle,    
            pointToLayer: function (data, latlng) {
               return L.circleMarker(latlng, {style: defaultStyle});
            },

            // And link up the function to run when loading each feature
            onEachFeature: onEachFeature
        },
        // Add to map after loading (default: true) ?
        addToMap: true,
        // File size limit in kb (default: 1024) ?
        fileSizeLimit: 1024,
        // Restrict accepted file formats (default: .geojson, .json, .kml, and .gpx) ?
        formats: [
            '.geojson',
            '.kml'
        ]
    }).addTo(map);

    control.loader.on('data:loaded', function (event) {
        // event.layer gives you access to the layers you just uploaded!
        console.log("layer loaded:", event.layer, event.filename);
        // event.layer.options.name = event.filename;
        event.layer.name = event.filename;
        activeLayer = event.layer;

        // Add to map layer switcher
        layerswitcher.addOverlay(event.layer, event.filename);

    }); 
    control.loader.on('data:error', function (error) {  
        // Do something usefull with the error!
        console.error(error);
    });      
    var layerswitcher = L.control.layers(baseMaps,overlayMaps).addTo(map);
    map.on('layeradd', function(event, layername) {
        var layer = event.layer;
        //console.log("layeradd", layer.name, event);
        
        if (layer._latlngs) {
            layer.on({
                mouseover: function(e) {   
                    highlightFeature(e, null, layer); 
                },
                mouseout:resetHighlight
            });
            layer.bindPopup('<h1>layer: '+ layer._leaflet_id +'</h1><p>length: '+layer._latlngs.length+'</p>');
        }
        
        if (layer.name) {
            console.log("layeradd", event, layer.name);
        }
    })
    
    map.on('overlayadd', function(event) {
        activeLayer = event.layer;
    })
    
    map.on('overlayremove', function(event) {
        console.log('layer removed', event.name);
    })
 
    </script>
</html>
